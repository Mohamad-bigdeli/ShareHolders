
# این API برای دریافت لیست تاریخچه سهامداران یک شرکت بورسی خاص بر اساس نماد بورسی طراحی شده است. این API از صفحه‌بندی پشتیبانی می‌کند و نتایج آن برای بهبود عملکرد به مدت 15 دقیقه کش می‌شوند.

## اطلاعات کلی
- **مسیر (Endpoint):** `/api/shareholders/<str:symbol>/`
- **متد:** `GET`
- **فرمت پاسخ:** JSON
- **پشتیبانی از صفحه‌بندی:** دارد (با استفاده از کلاس `CustomPagination`)
- **کشینگ:** نتایج به مدت 15 دقیقه کش می‌شوند (`cache_page(60 * 15)`)

## پارامترهای ورودی
این API یک پارامتر مسیر (Path Parameter) دریافت می‌کند:

| پارامتر   | نوع    | توضیحات                           | اجباری؟ |
|-----------|--------|-----------------------------------|----------|
| `symbol`  | String | نماد بورسی شرکت (مثال: "فملی")  | بله      |

### توضیحات پارامتر
- **symbol**: نماد بورسی شرکت (مانند "فملی"، "شستا"، "خساپا") که برای فیلتر کردن تاریخچه سهامداران استفاده می‌شود.

## پاسخ API
پاسخ API به‌صورت JSON و شامل لیست تاریخچه سهامداران برای نماد مشخص‌شده است. در صورت استفاده از صفحه‌بندی، پاسخ شامل متادیتای صفحه‌بندی نیز خواهد بود.

### ساختار پاسخ (با صفحه‌بندی)
```json
{
  "count": 10,
  "next": "http://127.0.0.1:8000/shareholder/api/v1/shareholders/خودرو/?page=2",
  "previous": null,
  "results": [
    {
      "id": "12345",
      "shareholder_name": "شرکت سرمایه‌گذاری صبا تامین",
      "symbol": "فملی",
      "shareholder_shares": 1500000000,
      "shareholder_percentage": 5.25,
      "date": "2025-04-19",
      "change": 0.15,
      "created_at": "2025-04-19T10:00:00Z",
      "updated_at": "2025-04-19T12:00:00Z"
    },
    ...
  ]
}
```

### توضیحات فیلدهای پاسخ
- **id**: شناسه یکتای رکورد سهامدار.
- **shareholder_name**: نام سهامدار (مثال: "شرکت سرمایه‌گذاری صبا تامین").
- **symbol**: نماد بورسی شرکت (مثال: "فملی").
- **shareholder_shares**: تعداد سهام در اختیار سهامدار.
- **shareholder_percentage**: درصد مالکیت سهامدار.
- **date**: تاریخ گزارش.
- **change**: تغییر درصد مالکیت نسبت به گزارش قبلی.
- **created_at**: زمان ایجاد رکورد.
- **updated_at**: زمان آخرین به‌روزرسانی رکورد.

## خطاها
در صورت بروز خطا، پاسخ API شامل یک پیام خطا و کد وضعیت HTTP خواهد بود:

### خطای عدم ارائه نماد
```json
{
  "error": "پارامتر نماد اجباری است"
}
```
- **کد وضعیت:** `400 Bad Request`

### خطای عدم وجود داده
```json
{
  "error": "نماد وجود ندارد یا داده‌ای برای آن ثبت نشده است"
}
```
- **کد وضعیت:** `404 Not Found`

## مثال‌های استفاده
### 1. دریافت تاریخچه سهامداران برای نماد "فملی"
**درخواست:**
```bash
curl -X GET "http://127.0.0.1:8000/shareholder/api/v1/shareholders/فملی/"
```

**پاسخ:**
```json
{
  "count": 2,
  "next": null,
  "previous": null,
  "results": [
    {
      "id": "12345",
      "shareholder_name": "شرکت سرمایه‌گذاری صبا تامین",
      "symbol": "فملی",
      "shareholder_shares": 1500000000,
      "shareholder_percentage": 5.25,
      "date": "2025-04-19",
      "change": 0.15,
      "created_at": "2025-04-19T10:00:00Z",
      "updated_at": "2025-04-19T12:00:00Z"
    },
    {
      "id": "67890",
      "shareholder_name": "شرکت سرمایه‌گذاری ملی ایران",
      "symbol": "فملی",
      "shareholder_shares": 2000000000,
      "shareholder_percentage": 7.1,
      "date": "2025-04-19",
      "change": -0.2,
      "created_at": "2025-04-19T09:00:00Z",
      "updated_at": "2025-04-19T11:00:00Z"
    }
  ]
}
```

### 2. درخواست برای نماد ناموجود
**درخواست:**
```bash
curl -X GET "http://127.0.0.1:8000/shareholder/api/v1/shareholders/ناموجود/"
```

**پاسخ:**
```json
{
  "error": "نماد وجود ندارد یا داده‌ای برای آن ثبت نشده است"
}
```
_______________________________________________________

# مستندات API تغییرات سهامداران (روزانه، هفتگی، ماهانه)

این API برای دریافت تغییرات سهامداران یک شرکت بورسی خاص بر اساس نماد بورسی طراحی شده است. این API تغییرات سهامداران را در بازه‌های زمانی روزانه، هفتگی و ماهانه ارائه می‌دهد و از صفحه‌بندی پشتیبانی می‌کند. نتایج برای بهبود عملکرد به مدت 15 دقیقه کش می‌شوند.

## اطلاعات کلی
- **مسیرهای (Endpoints):**
  - `shareholder/api/v1/shareholders/changes/daily/<str:symbol>` (تغییرات روزانه)
  - `shareholder/api/v1/shareholders/changes/weekly/<str:symbol>` (تغییرات هفتگی)
  - `shareholder/api/v1/shareholders/changes/monthly/<str:symbol>` (تغییرات ماهانه)
- **متد:** `GET`
- **فرمت پاسخ:** JSON
- **پشتیبانی از صفحه‌بندی:** دارد (با استفاده از کلاس `CustomPagination`)
- **کشینگ:** نتایج به مدت 15 دقیقه کش می‌شوند (`cache_page(60 * 15)`)
- **وضعیت احراز هویت:** در حال حاضر غیرفعال است (`permission_classes = [IsAuthenticated]` غیرفعال شده)

## پارامترهای ورودی
این API یک پارامتر مسیر (Path Parameter) دریافت می‌کند:

| پارامتر   | نوع    | توضیحات                           | اجباری؟ |
|-----------|--------|-----------------------------------|----------|
| `symbol`  | String | نماد بورسی شرکت (مثال: "فملی")  | بله      |

### توضیحات پارامتر
- **symbol**: نماد بورسی شرکت (مانند "فملی"، "شستا"، "خساپا") که برای محاسبه تغییرات سهامداران استفاده می‌شود.

## پاسخ API
پاسخ API به‌صورت JSON و شامل لیست تغییرات سهامداران برای نماد مشخص‌شده است. تغییرات شامل تعداد سهام، درصد مالکیت و نوع تغییر (صعودی، نزولی یا بدون تغییر) است. در صورت استفاده از صفحه‌بندی، پاسخ شامل متادیتای صفحه‌بندی نیز خواهد بود.

### ساختار پاسخ (با صفحه‌بندی)
```json
{
  "count": 10,
  "next": "http://127.0.0.1:8000/shareholder/api/v1/shareholders/changes/daily/فملی/?page=2",
  "previous": null,
  "results": [
    {
      "shareholder_id": 12345,
      "shareholder_name": "شرکت سرمایه‌گذاری صبا تامین",
      "current_shares": 1500000000,
      "previous_shares": 1450000000,
      "change_shares": 50000000,
      "current_percentage": 5.25,
      "previous_percentage": 5.0,
      "change_percentage": 0.25,
      "changes": "صعودی"
    },
    {
      "shareholder_id": 67890,
      "shareholder_name": "شرکت سرمایه‌گذاری ملی ایران",
      "current_shares": 2000000000,
      "previous_shares": 2100000000,
      "change_shares": -100000000,
      "current_percentage": 7.1,
      "previous_percentage": 7.5,
      "change_percentage": -0.4,
      "changes": "نزولی"
    }
  ]
}
```

### توضیحات فیلدهای پاسخ
- **shareholder_id**: شناسه یکتای سهامدار.
- **shareholder_name**: نام سهامدار (مثال: "شرکت سرمایه‌گذاری صبا تامین").
- **current_shares**: تعداد سهام فعلی سهامدار.
- **previous_shares**: تعداد سهام قبلی سهامدار (در بازه زمانی مشخص‌شده: روزانه، هفتگی یا ماهانه).
- **change_shares**: تغییر در تعداد سهام (مثبت برای افزایش، منفی برای کاهش).
- **current_percentage**: درصد مالکیت فعلی سهامدار.
- **previous_percentage**: درصد مالکیت قبلی سهامدار.
- **change_percentage**: تغییر در درصد مالکیت (مثبت برای افزایش، منفی برای کاهش).
- **changes**: نوع تغییر:
  - `"صعودی"`: افزایش تعداد سهام.
  - `"نزولی"`: کاهش تعداد سهام.
  - `"بدون تغییر"`: بدون تغییر در تعداد سهام.
  - `"صعودی تغییرات به بالای 1 آمده"`: سهامدار جدید با درصد مالکیت بالای 1%.
  - `"نزولی تغییرات به زیر 1 آمده"`: سهامدار دیگر مالکیت بالای 1% ندارد.

## خطاها
در صورت بروز خطا، پاسخ API شامل یک پیام خطا و کد وضعیت HTTP خواهد بود:

### خطای عدم ارائه نماد
```json
{
  "error": "پارامتر نماد اجباری است"
}
```
- **کد وضعیت:** `400 Bad Request`

### خطای محاسبه تغییرات
```json
{
  "error": "خطا در محاسبه تغییرات: [جزئیات خطا]"
}
```
- **کد وضعیت:** `500 Internal Server Error`

## مثال‌های استفاده
### 1. دریافت تغییرات روزانه سهامداران برای نماد "فملی"
**درخواست:**
```bash
curl -X GET "http://127.0.0.1:8000/shareholder/api/v/shareholders/changes/daily/فملی/"
```

**پاسخ:**
```json
{
  "count": 2,
  "next": null,
  "previous": null,
  "results": [
    {
      "shareholder_id": 12345,
      "shareholder_name": "شرکت سرمایه‌گذاری صبا تامین",
      "current_shares": 1500000000,
      "previous_shares": 1450000000,
      "change_shares": 50000000,
      "current_percentage": 5.25,
      "previous_percentage": 5.0,
      "change_percentage": 0.25,
      "changes": "صعودی"
    },
    {
      "shareholder_id": 67890,
      "shareholder_name": "شرکت سرمایه‌گذاری ملی ایران",
      "current_shares": 2000000000,
      "previous_shares": 2100000000,
      "change_shares": -100000000,
      "current_percentage": 7.1,
      "previous_percentage": 7.5,
      "change_percentage": -0.4,
      "changes": "نزولی"
    }
  ]
}
```

### 2. دریافت تغییرات هفتگی سهامداران برای نماد "شستا"
**درخواست:**
```bash
curl -X GET "http://127.0.0.1:8000/shareholder/api/v1/shareholders/changes/weekly/شستا/"
```

**پاسخ:**
```json
{
  "count": 1,
  "next": null,
  "previous": null,
  "results": [
    {
      "shareholder_id": 98765,
      "shareholder_name": "صندوق بازنشستگی کشوری",
      "current_shares": 1000000000,
      "previous_shares": 0,
      "change_shares": 1000000000,
      "current_percentage": 3.5,
      "previous_percentage": 0,
      "change_percentage": 3.5,
      "changes": "صعودی تغییرات به بالای 1 آمده"
    }
  ]
}
```

### 3. درخواست برای نماد ناموجود یا خطا در محاسبه
**درخواست:**
```bash
curl -X GET "http://127.0.0.1:8000/shareholder/api/v1/shareholders/changes/monthly/ناموجود/"
```

**پاسخ:**
```json
{
  "error": "خطا در محاسبه تغییرات: نماد نامعتبر است"
}
```
- **کد وضعیت:** `500 Internal Server Error`

## توضیحات اضافی
- **بازه‌های زمانی:**
  - **روزانه**: مقایسه داده‌های امروز با روز معاملاتی قبلی.
  - **هفتگی**: مقایسه داده‌های امروز با 7 روز قبل (روز معاملاتی متناظر).
  - **ماهانه**: مقایسه داده‌های امروز با 30 روز قبل (روز معاملاتی متناظر).
- **وظایف پس‌زمینه (Tasks):** محاسبات تغییرات از طریق وظایف پس‌زمینه (`daily_changes_task`, `weekly_changes_task`, `monthly_changes_task`) انجام می‌شوند که ممکن است به سیستم‌هایی مانند Celery وابسته باشند.
- **کشینگ:** استفاده از دکوراتور `cache_page(60 * 15)` باعث می‌شود نتایج برای 15 دقیقه ذخیره شوند تا فشار بر سرور کاهش یابد.
- **صفحه‌بندی:** از کلاس `CustomPagination` برای صفحه‌بندی استفاده می‌شود که تعداد نتایج در هر صفحه و ناوبری بین صفحات را مدیریت می‌کند.

این مستندات برای توسعه‌دهندگان و کاربرانی که قصد استفاده از API تغییرات سهامداران را دارند، تهیه شده است.

______________________________________________

# مستندات API جستجوی سهامداران

این API برای جستجوی تاریخچه سهامداران یک شرکت بورسی بر اساس نماد بورسی، نام سهامدار یا شناسه سهامدار طراحی شده است. این API از صفحه‌بندی پشتیبانی می‌کند و نتایج آن برای بهبود عملکرد به مدت 15 دقیقه کش می‌شوند.

## اطلاعات کلی
- **مسیر (Endpoint):** `/api/shareholders/search/<str:query>/`
- **متد:** `GET`
- **فرمت پاسخ:** JSON
- **پشتیبانی از صفحه‌بندی:** دارد (با استفاده از کلاس `CustomPagination`)
- **کشینگ:** نتایج به مدت 15 دقیقه کش می‌شوند (`cache_page(60 * 15)`)
- **وضعیت احراز هویت:** در حال حاضر غیرفعال است (`permission_classes = [IsAuthenticated]` غیرفعال شده)

## پارامترهای ورودی
این API یک پارامتر مسیر (Path Parameter) دریافت می‌کند:

| پارامتر  | نوع    | توضیحات                                              | اجباری؟ |
|----------|--------|-----------------------------------------------------|----------|
| `query`  | String | نماد بورسی، نام سهامدار یا شناسه سهامدار (مثال: "فملی") | بله      |

### توضیحات پارامتر
- **query**: عبارتی که برای جستجو در فیلدهای `symbol` (نماد بورسی) یا `shareholder_name` (نام سهامدار) استفاده می‌شود. این پارامتر می‌تواند شامل نماد بورسی (مانند "فملی")، نام سهامدار (مانند "شرکت سرمایه‌گذاری صبا تامین") یا شناسه سهامدار باشد.

## پاسخ API
پاسخ API به‌صورت JSON و شامل لیست تاریخچه سهامداران مطابق با عبارت جستجو است. در صورت استفاده از صفحه‌بندی، پاسخ شامل متادیتای صفحه‌بندی نیز خواهد بود.

### ساختار پاسخ (با صفحه‌بندی)
```json
{
  "count": 10,
  "next": "http://127.0.0.1:8000/shareholder/api/v1/shareholders/search/فملی/?page=2",
  "previous": null,
  "results": [
    {
      "id": "12345",
      "shareholder_name": "شرکت سرمایه‌گذاری صبا تامین",
      "symbol": "فملی",
      "shareholder_shares": 1500000000,
      "shareholder_percentage": 5.25,
      "date": "2025-04-19",
      "change": 0.15,
      "created_at": "2025-04-19T10:00:00Z",
      "updated_at": "2025-04-19T12:00:00Z"
    },
    {
      "id": "67890",
      "shareholder_name": "شرکت سرمایه‌گذاری ملی ایران",
      "symbol": "فملی",
      "shareholder_shares": 2000000000,
      "shareholder_percentage": 7.1,
      "date": "2025-04-19",
      "change": -0.2,
      "created_at": "2025-04-19T09:00:00Z",
      "updated_at": "2025-04-19T11:00:00Z"
    }
  ]
}
```

### توضیحات فیلدهای پاسخ
- **id**: شناسه یکتای رکورد سهامدار.
- **shareholder_name**: نام سهامدار (مثال: "شرکت سرمایه‌گذاری صبا تامین").
- **symbol**: نماد بورسی شرکت (مثال: "فملی").
- **shareholder_shares**: تعداد سهام در اختیار سهامدار.
- **shareholder_percentage**: درصد مالکیت سهامدار.
- **date**: تاریخ گزارش (میلادی).
- **change**: تغییر درصد مالکیت نسبت به گزارش قبلی.
- **created_at**: زمان ایجاد رکورد.
- **updated_at**: زمان آخرین به‌روزرسانی رکورد.

## خطاها
در صورت بروز خطا، پاسخ API شامل یک پیام خطا و کد وضعیت HTTP خواهد بود:

### خطای عدم ارائه پارامتر جستجو
```json
{
  "error": "پارامتر نماد یا نام سهامدار و یا شناسه سهامدار برای جستجو اجباری است"
}
```
- **کد وضعیت:** `400 Bad Request`

### خطای عدم وجود داده
```json
{
  "detail": "نتیجه ای برای جستجو یافت نشد"
}
```
- **کد وضعیت:** `404 Not Found`

## مثال‌های استفاده
### 1. جستجوی سهامداران با نماد "فملی"
**درخواست:**
```bash
curl -X GET "http://127.0.0.1:8000/shareholder/api/v1/shareholders/search/فملی/"
```

**پاسخ:**
```json
{
  "count": 2,
  "next": null,
  "previous": null,
  "results": [
    {
      "id": "12345",
      "shareholder_name": "شرکت سرمایه‌گذاری صبا تامین",
      "symbol": "فملی",
      "shareholder_shares": 1500000000,
      "shareholder_percentage": 5.25,
      "date": "2025-04-19",
      "change": 0.15,
      "created_at": "2025-04-19T10:00:00Z",
      "updated_at": "2025-04-19T12:00:00Z"
    },
    {
      "id": "67890",
      "shareholder_name": "شرکت سرمایه‌گذاری ملی ایران",
      "symbol": "فملی",
      "shareholder_shares": 2000000000,
      "shareholder_percentage": 7.1,
      "date": "2025-04-19",
      "change": -0.2,
      "created_at": "2025-04-19T09:00:00Z",
      "updated_at": "2025-04-19T11:00:00Z"
    }
  ]
}
```

### 2. جستجوی سهامداران با نام "شرکت سرمایه‌گذاری صبا تامین"
**درخواست:**
```bash
curl -X GET "http://127.0.0.1:8000/shareholder/api/v1/shareholders/search/شرکت%20سرمایه‌گذاری%20صبا%20تامین/"
```

**پاسخ:**
```json
{
  "count": 1,
  "next": null,
  "previous": null,
  "results": [
    {
      "id": "12345",
      "shareholder_name": "شرکت سرمایه‌گذاری صبا تامین",
      "symbol": "فملی",
      "shareholder_shares": 1500000000,
      "shareholder_percentage": 5.25,
      "date": "2025-04-19",
      "change": 0.15,
      "created_at": "2025-04-19T10:00:00Z",
      "updated_at": "2025-04-19T12:00:00Z"
    }
  ]
}
```

### 3. جستجو با عبارت ناموجود
**درخواست:**
```bash
curl -X GET "http://127.0.0.1:8000/shareholder/api/v1/shareholders/search/ناموجود/"
```

**پاسخ:**
```json
{
  "detail": "نتیجه ای برای جستجو یافت نشد"
}
```
- **کد وضعیت:** `404 Not Found`

## توضیحات اضافی
- **جستجو:** جستجو با استفاده از `SearchVector` روی فیلدهای `symbol` و `shareholder_name` انجام می‌شود. این امکان جستجوی سریع و کارآمد را فراهم می‌کند.
- **کشینگ:** استفاده از دکوراتور `cache_page(60 * 15)` باعث می‌شود نتایج برای 15 دقیقه ذخیره شوند تا فشار بر سرور کاهش یابد.
- **صفحه‌بندی:** از کلاس `CustomPagination` برای صفحه‌بندی استفاده می‌شود که تعداد نتایج در هر صفحه و ناوبری بین صفحات را مدیریت می‌کند.
- **شاخص‌ها (Indexes):** مدل `ShareholdersHistory` دارای شاخص‌هایی روی فیلدهای `symbol`، `date` و `shareholder_name` است که عملکرد جستجو را بهبود می‌بخشد.

این مستندات برای توسعه‌دهندگان و کاربرانی که قصد استفاده از API جستجوی سهامداران را دارند، تهیه شده است.